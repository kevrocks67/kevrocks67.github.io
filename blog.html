<!DOCTYPE html/>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>My Blog</title>
        <meta name="description" content="Kevin Diaz Blog">
        <meta name="author" content="Kevin Diaz">
        <link rel="stylesheet" type="text/css" href="css/blog.css">
    </head>

    <body>
      <div id="index">
        <center>
            <h1>Kevin's Blog <a href="blogindex.html">[Index]</a></h1>
            <a href="https://linkedin.com/in/kevin-diaz-216a82143/"><img src="src/linkedin.png" width="40" height="40"></a>
            <a href="https://github.com/kevrocks67"><img src="src/git.png" width="40" height="40"></a>
            <a href="https://kevrocks67.github.io/rss.xml"><img src="src/rss.png" width="40" height="40"></a>
            <h3><a href="index.html">Return to main site</a></h3>
        </center>
      </div>

        <!-- LB -->
<div class='entry'>
<h2 id='qemu-port-forwarding-using-iptables'><a
href=blog/qemu-port-forwarding-using-iptables.html>QEMU Port Forwarding Using Iptables</a></h2>
<small>[<a href='#qemu-port-forwarding-using-iptables'>link</a>&mdash;<a href='blog/qemu-port-forwarding-using-iptables.html'>standalone</a>]</small>
<p>
Normally, there is no website when I go to my debian server's IP address in my browser. However,
I have a web server running in a QEMU VM on that server and would like to access it from my
laptop. After following the steps in this guide, I am able to access that web server by going to
the IP of my debian server as if it was installed on the server itself. Unless you give the VM
its own real IP address from the router, we cannot access that VM from another computer. That
being said we may not want to give the VM its own TAP and IP address. The alternative is to
forward all requests to the host computer on a specific port to the port on the VM for the
service you want to access. I used iptables to do this port forwarding just like we do port
forwarding on our home routers. Our routers use NAT to do port forwarding allowing us to access
services in our homes from across the internet. We can replicate this in our VM's
with the below iptables rules.
</p>

<b>NOTE:</b>In the case described below, 192.168.1.250 is the IP address of the debian server
and 192.168.122.215 is the ip address of the VM. Both of these devices are on a /24 subnet.
The interface on which the debian server connects to my home network is enp2s0.

<br>
<br>

First we enable this NAT functionality by setting the MASQUERADE option.

<pre>sudo iptables -t nat -A POSTROUTING -j MASQUERADE</pre>

Then, we set a PREROUTING rule which lets the host device detect any incoming connections on port
80 for our network interface and redirect it to the VM's IP address on port 80 instead of
attempting to connect to the hosts own port 80.

<pre>
sudo iptables -t nat -A PREROUTING -d 192.168.1.250/24 -i enp2s0 -p tcp --dport 80 -j DNAT \
--to-destination 192.168.122.215:80
</pre>

Finally, we set a FORWARD rule which ensures the packet actually gets sent to port 80 on the VM and
that the VM is open to accepting that packet.

<pre>
sudo iptables -I FORWARD -p tcp -d 192.168.122.215/24 --dport 80 -m state --state \
NEW,RELATED,ESTABLISHED -j ACCEPT
</pre>
<small>Wed, 08 May 2019 23:47:10 -0400</small>
</div>
<div class='entry'>
<h2 id='qemu-host-only-networking'><a href="blog/qemu-host-only-networkin.html">QEMU Host Only Networking</a></h2>
<small>[<a href='#qemu-host-only-networking'>link</a>&mdash;<a href='blog/qemu-host-only-networking.html'>standalone</a>]</small>
<p>
Often times, it is useful to use a host-only network in a lab environment, especially when
dealing with certain security labs. What a host-only network allows is for your virtual machines
to communicate with each other on their own independent network and communicate to the host
computer/hypervisor. However, the VM's will not be able to reach out to other devices on your
network and devices on your network will not be able to reach them. In order to set up this
isolated environment, you need to create a bridge and tap just like any other VM networking set
up. There are two methods to do this, one is manually and the other automatically using the
libvirt XML format.
</p>

<h3>Libvirt XML Method</h3>
<p>
In order to do this the easy way, you can create an XML file whose contents are the below.
This is simply the default network setup but without the forward tags. This makes it so the
network is limited to the virtual environment. I renamed the bridge to "virbr1" instead of the
default "virbr0" so there is no conflict. I also changed the last byte of the mac address and set
an appropriate DHCP range and IP address as to not interfere with the other network. Here I simply
changed the IP from the 192.168.122.0/24 subnet to 192.168.123.0/24. In the DHCP range, do not
forget to leave out the .255 address since this IP is used for broadcast.
Finally, I changed the name to secnet to help me identify it. I called it
that because this is the network I use for security labs, often with vulnerable
systems, which I want no where near my real network.
</p>
<pre>
    &lt;network&gt;
      &lt;name&gt;secnet&lt;/name&gt;
      &lt;uuid&gt;8f49de66-0947-4271-85a4-2bbe88913555&lt;/uuid&gt;
      &lt;bridge name='virbr1' stp='on' delay='0'/&gt;
      &lt;mac address='52:54:00:95:26:26'/&gt;
      &lt;ip address='192.168.123.1' netmask='255.255.255.0'&gt;
        &lt;dhcp&gt;
          &lt;range start='192.168.123.30' end='192.168.123.254'/&gt;
        &lt;/dhcp&gt;
      &lt;/ip&gt;
    &lt;/network&gt;
</pre>

After creating this file, simply run <i>virsh net-define file_name.xml</i> and <i>virsh net-start
file_name</i>. If all is well you have officially set up the network and can configure the client.
You can do this either through virt-manager by changing the NIC settings from the default
networks bridge to your bridge, in this case, virbr1, or you can do <i>virsh edit domain</i> and
look for a line with &lt;interface type='bridge'&gt; and modify the value for source. If you
have no NIC set up at all, add the following lines to your code, modifying certain values such
as the mac address and pci slot under the address tag as necessary. When you boot up the client
it should automatically get a DHCP address.

<pre>
    &lt;interface type='bridge'&gt;
      &lt;mac address='52:54:00:8c:d0:7e'/&gt;
      &lt;source bridge='virbr1'/&gt;
      &lt;model type='virtio'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/&gt;
    &lt;/interface&gt;
</pre>
</P>

<h3>Manual Method</h3>
 <p>
Although you can do the above method and have it work well, there are times when you want to
learn what actually happens behind the scenes and how it all works. In order to do this, you have
to understand that the virtual network is made up of a bridge and a tap where the tap acts as a
virtual NIC for the VM. The bridge is what hosts the network and acts as a router. We need to
create this bridge, assign it an IP, then create the tap and make the bridge a slave of the tap.
At this point, a functioning network will be established with static IP addresses. If you want
DHCP, you can do so using dnsmasq. Finally, add the appropriate settings to the VM as described
above in the XML method. From there on out, everything else is simply a matter of
configuring the client itself. The only negative to this manual method is that you have to start
and stop the network manually, but this is easily scriptable.
</p>

<pre>
    # Create the virtual bridge and name it secnet and bring the interface up
    sudo ip link add secnet type bridge; sudo ip link set secnet up

    # Create the tap and name it secnet-nic (you can call it whatever you want)
    sudo ip tuntap add dev secnet-nic mode tap

    # Bring up the interface in promiscuous mode
    sudo ip link set secnet-nic up promisc on

    # Make secnet-nic a slave of secnet
    sudo ip link set secnet-nic master secnet

    # Give bridge secnet an IP address of 192.168.123.1
    sudo ip addr add 192.168.123.1/24 broadcast 192.168.123.255 dev secnet
</pre>

<b>DHCP With dnsmasq</b>
<p>
Setting up DHCP with dnsmasq is simple. You can either write out the config within the command,
as is shown below, or you can create a config file which you can read from, also shown below.
The important steps in running dnsmasq are setting the correct interface and DHCP range as well
as setting the -p option to 0. When the -p option is set to 0, the DNS function of dnsmasq will
no longer start which removes conflicts with any active DNS servers on your host computer. I
have this problem since I use dnscrypt on my laptop, however, you may not encounter such
conflict. There is no real need to host our own DNS server so nothing is lost by doing this.
<br>
<b>Note:</b> The secnet config provided below was generated by libvirt when using the XML method
taught in this blog.

<pre>
    sudo dnsmasq --interface secnet -p 0 --bind-interfaces --dhcp-range=192.168.123.10,192.168.123.254

    or

    sudo dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/secnet.conf --leasefile-ro

    # secnet.conf
    strict-order
    pid-file=test.pid
    except-interface=lo
    bind-dynamic
    interface=secnet
    dhcp-option=3
    no-resolv
    ra-param=*,0,0
    dhcp-range=192.168.123.30,192.168.123.254,255.255.255.0
    dhcp-no-override
    dhcp-authoritative
    dhcp-lease-max=225
    dhcp-hostsfile=test.hostsfile
    addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts
</pre>
</p>

<p>
If you did not set up DHCP using dnsmasq you will have to manually set up the IP
and default gateway route on the client. It is simply two lines if you use the command line
and a few changes within the settings panel of whatever desktop environment you're using in the
vm.
</p>

<pre>
    # Assign an ip address to the interface
    ip addr add 192.168.123.2/24 dev eth0

    # Add the default gateway route which is the secnet address
    route add default gw 192.168.123.1 eth0

    # Test network connectivity
    ping 1.1.1.1

    # There is no DNS assigned so you have to manually add a server in resolv.conf
    echo 1.1.1.1 > /etc/resolv.conf

    # Final network connectivity test with DNS resolution
    ping google.com
</pre>
</p>

<p>
If you followed all the steps in this guide, you will have successfully created an isolated
host-only network. To confirm this, try pinging a device in your network such as your phone.
This should not work, but you should be able to ping the host computer at 192.168.123.1 and
other VM's on the same network.
</p>
<small>Fri, 03 May 2019 16:22:01 -0400</small>
</div>

		<div class="entry">
			<h2 id='running-vmware-images-in-qemu'><a href="blog/running-vmware-images-in-qemu.html">Running VMware Images in QEMU</a></h2>
			<small>[<a href="blog.html#running-vmware-images-in-qemu">link</a>&mdash;<a href="blog/running-vmware-images-in-qemu.html">standalone</a>]</small>

			<p>
	      In order to keep true to the FLOSS philosophy, I prefer to virtualize things using QEMU
        KVM.
        This also allows me to practice with the tools used in a lot of Linux environments for
        virtualization. Although it is a great tool for deploying your own virtual machines, it
        gets in the way when I want to open up a VM image for a security lab or some pre-made tool such
        as SIFT Workstation since they usually come in either virtual box or VMware images. While I
        could just download those tools, I prefer not to add more programs to my computer unless
        it is absolutely necessary. Of course, I also just like to find new ways of doing things.
        I hate seeing people online responding with "just download XYZ program and be done with
        it". Yes I can download VMware workstation if I needed it at work for something really
        quick and it will most likely work, but when it comes doing things  at home, that mindset
        is soooo boring.
			</p>
      <p>
        Normally, VMware images come in a *.ova file. The first thing to realize is that if you
        run file on the ova, you will notice that it is simply seen as a tar archive. The ova
        holds multiple files inside including the actual image, normally in a. The ova holds
        multiple files inside including the actual image, normally in a *.vmdk file, and a *.ovf
        file which is an XML file with information pertaining to the VM, comparable to the QEMU
        XML used to configure your VM settings. You may also find other files in there such as
        an ISO or a file with hashes. <b><em>The only file we care about though is the *.vmdk file as
        that is the one with the actual image.</em></b> If there are more than one, the file which
        has the name most comparable to the original *.ova filename should be the correct one. If it
        turns out this one does not work after the following process, you can always try the other one.
      </p>
      <p>
        We will be converting the vmdk to qcow2. I chose this format simply because its the one I
        use with my other images and it works well with this conversion process. To convert it,
        you need to use the qemu-img and its convert function. After this point, we will be able
        to load the qcow2 image as a regular disk image in QEMU. You can do this through
        virt-manager, virt-install or copy another VM's XML and change the source for the disk as
        well as other options like the name, the UUID, and the MAC address. Something else you can
        try for a quick test is qemu-system-x86_64 but this can sometimes be very slow unless you
        set a ton of argument options.
      </p>
      <p>
        Here are the actual steps:
        <ol>
          <li>tar -xvf original.ova</li>
          <li>qemu-img convert -O qcow2 original.vmdk original.qcow2</li>
          <li>Run the qcow2 image in QEMU</li>
          <li>If it does not boot, try the other vmdk file if there is one</li>
        </ol>
      </p>
      <p>
        As you can see, it is pretty simple to do this and so far have used it on 3 different VMware
        images flawlessly. However, you have to realize it may take some experimentation. Do not
        give up on it right away and you will be able to avoid downloading extra software and
        avoid looking for the correct free trial version or getting an expensive license.
      </p>
			<b><small>Wed, 30 Jan 2019</small></b>
		</div>

		<div class="entry">
			<h2 id='detecting-the-effect-of-a-phishing-attack-on-your-gsuite-domain'><a href="blog/detecting-the-effect-of-a-phishing-attack-on-your-gsuite-domain.html">Detecting The Effect Of A Phishing Attack On Your G Suite Domain</a></h2>
			<small>[<a href="blog.html#detecting-the-effect-of-a-phishing-attack-on-your-gsuite-domain">link</a>&mdash;<a href="blog/detecting-the-effect-of-a-phishing-attack-on-your-gsuite-domain.html">standalone</a>]</small>

			<p>
				One of the things we have to be weary of as administrators is security. Phishing attacks are constantly becoming harder to detect and defend against. Other times, it is quite
                easy to detect. In this post I will tell you what to do when you detect a phishing attack on your domain and how to mitigate.
			</p>
            <p>
                Recently our domain received a phishing attack which told users that they had a new voicemail from someone and to click on a link to view it. When clicked, you were redirected to
                an outlook login page with your email address already entered in the username field. None of the IT department received the email, but a lot of employees did. We received a question
                about it from one employee and did not think much of it. I simply recommended that they not open it as I thought it was an isolated incident. I now realize that I should have done
                more in response. No less than an hour later, I received two more questions about the same email. Luckily, those two employees realized it looked sketchy and did not click on the
                link.
                I instantly knew that this was a phishing attack on the domain. All of the emails had
                the same sender, but slightly different subject lines so I knew that the sender was the constant I needed to use to run my audit.
            </p>
            <p>
                To run my audit, these are the steps I took:
                <ol>
                <li>Log in to G Suite dashboard</li>
                <li>Go to "Reports" tab</li>
                <li>Scroll down to the audit section on the sidebar and select "Email Log Search"</li>
                <li>Enter your desired search parameters, in this case the senders email address</li>
                <li>Select an appropriate time frame to check. I checked the last 7 days since it was recent</li>
                <li>Save the results as a google sheets file in the upper right corner and share it with your team</li>
                </ol>

                Now that we have the logs, we can start mitigating the problem. The first thing I did was to cut the head off the snake by setting a global block on the email address in the
                G Suite admin console. Afterwards, I prepared an email advising all employees of the situation, what to look for, what happens when you click on the link, and what to do if they
                have received the email. Using the logs, I was able to also individually verify with those affected if they had clicked on the link and then reset their passwords. Lastly, I was
                able to detect the time and date of incident which was actually the night before. I was not alerted to it until the next evening so it is possible that multiple people clicked on the
                link.
            </p>
            <h3>Takeaways</h3>
            <p>
                There is not a lot we can do about these attacks except deal with them after they occur. A password compromise of a super admin account via a phishing attack could be devastating
                for your domain as the attacker will have complete control over everything. This is also one of the reasons you should educate your users and administrators on the dangers of such
                attacks and how to detect them. Next time, I will be sure to run an audit as soon as I see the first message since it is so easy and quick to do. It will help me reduce the number
                of people clicking on such emails. I will also look into some possible defensive cyber education for users.
            </p>
			<b><small>Thu, 22 Nov 2018</small></b>
		</div>

		<div class="entry">
			<h2 id='using-projectors-with-i3wm'><a href="blog/using-projectors-with-i3wm.html">Using Projectors with i3wm</a></h2>
			<small>[<a href="blog.html#using-projectors-with-i3wm">link</a>&mdash;<a href="blog/using-projectors-with-i3wm.html">standalone</a>]</small>

			<p>
				I use arch linux with i3-gaps on an old w520 I saved from being recycled. This computer and
                environment has truly helped me increase my efficiency. The downside, is that everything has
                to be manually configured. I do not mind this at all, however, because it has helped me
                understand how computers do certain things. If you were to just plug in the vga cord on a
                computer running i3wm, nothing would happen. You would then run xrandr to see if the vga
                connection even shows up and you will realize it has not. This is because there is no
                program running in the background to detect these display changes. You have to manually
                start the VGA output in xrandr. So, you run

                <code>xrandr --output VGA-1 --mode 1024x768</code>

                and find that now it works, but it looks really wierd. You try scaling the display and
                shifting it but find no success. Why is this?
			</p>
            <p>
                If we take a look at a windows computer, or even one running an actual DE like gnome,
                we can see that the screen resolution for both the output screen and the laptop
                display both change. In fact they set themselves to the same resolution as one another
                This seems like a simple idea, but unless you are actually
                paying attention when you plug in a vga cable, you do not really notice it. What
                I ended up doing to solve this problem was writing 2 small scripts. One I run when
                I plug in a vga output and another when I remove the vga output.

                To activate it, I use <code>xrandr --output LVDS-1-1 --mode 1024x768 --output VGA-0 --mode 1024x768</code>.
                To disable it, I use <code>xrandr --output LVDS-1-1 --mode 1920x1080 --output VGA-0 --off</code>.

                One thing I did notice is that the script for turning on the vga output will not work
                until you run xrandr on its own. It may have something with letting xrandr try and
                detect the new connection.
                There is probably a method to automate this process, but until I figure it out,
                this is what I will do. I only use vga occasionally to test projector and smartboard
                functionality after a repair.
            </p>
			<b><small>Mon, 22 Oct 2018</small></b>
		</div>


		<div class="entry">
			<h2 id='first-entry'><a href="blog/first-entry.html">First Entry</a></h2>
			<small>[<a href="blog.html#first-entry">link</a>&mdash;<a href="blog/first-entry.html">standalone</a>]</small>

			<p>
				This is my first blog entry. In this blog I plan to occassionally update it with tutorials on things
                I use in my day-to-day life, have learned or practiced in my home lab. I may possibly speak my opinion
                on certain topics in technology.
			</p>
			<b><small>Sun, 21 Oct 2018</small></b>
		</div>
    </body>
</html>

